<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title>Team Employees</title>
    <!--/*/ <th:block th:include="fragments/head :: head"></th:block> /*/-->
    <link rel="stylesheet" type="text/css" th:href="@{/css/projectEmployees.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/css/teamEmployees.css}">
</head>
<body>
<header>
    <!--/*/ <th:block th:include="fragments/header :: header('assign-tasks')"></th:block> /*/-->
</header>
<div style="margin-top: 70px; margin-left: 20px; ">
    <a th:href="@{'/project/' + ${projectId} + '/teams'}" style="cursor: pointer;"><img style="height: 20px;" src="data:image/png;base64, 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"></a>
    </div>
<div class="container" id="container">
    <div class="employee-list" th:if="${#authorization.expression('hasRole(''ROLE_ADMIN'')')}">
        <h1>Employee List For Teams</h1>
        
        <!-- Conditionally show the "Add Employee" section for admin users -->
        <div th:if="${#authorization.expression('hasRole(''ROLE_ADMIN'')')}">
            <div class="add-employee-section">
                <h2>Add Employee to Project</h2>
                <!-- Search bar for adding employees -->
                <input type="text" id="addEmployeeSearch" placeholder="Search..." onkeyup="filterAddEmployees()">
                <form id="addEmployeeForm" class="employee-form">
                    <table class="add-employee-table" id="addEmployeeTable">
                        <thead>
                            <tr>
                                <th>Select</th>
                                <th>Name</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Populate with available users -->
                            <tr th:each="user : ${availableUsers}" class="add-employee-row">
                                <td><input type="checkbox" name="userId" th:value="${user.id}" th:id="'user_' + ${user.id}" class="employee-checkbox"></td>
                                <td th:text="${user.name}"></td>
                            </tr>
                        </tbody>
                    </table>
                    <button class="btn" type="button" th:onclick="'addEmployeesToTeam(' + ${projectId} + ',' + ${teamId} + ')'">Add Employees</button>
                </form>
            </div>
        </div>
    </div>
   <div class="smallContainer">
    <h5>Employees in Team</h5>
    <!-- Search bar for deleting employees -->
    <input type="text" id="deleteEmployeeSearch" placeholder="Search..." onkeyup="filterDeleteEmployees()">
    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th th:if="${#authorization.expression('hasRole(''ROLE_ADMIN'')')}" style="text-align: center;">Assign Tasks</th>
                <th th:if="${#authorization.expression('hasRole(''ROLE_ADMIN'')')}" style="text-align: center;">
                    <!-- Checkbox to select all employees -->
                    <span>Delete Users</span>
                    <input type="checkbox" id="selectAllCheckbox" onchange="toggleAllCheckboxes()">
                </th>
            </tr>
        </thead>
        <tbody id="deleteEmployeeTable">
            <tr th:each="user : ${teamUsers}" class="delete-employee-row">
                <td th:text="${user.name}"></td>
                <td th:if="${#authorization.expression('hasRole(''ROLE_ADMIN'')')}" style="text-align: center;">
                    <a class="assign-btn" th:href="@{'/assignment/project/' + ${projectId} + '/team/' + ${teamId} + '/user/' + ${user.id}}">Assign</a>
                </td>
                <td th:if="${#authorization.expression('hasRole(''ROLE_ADMIN'')')}" style="text-align: center;">
                    <!-- Checkbox to select individual employees -->
                    <input type="checkbox" name="deleteUser" th:value="${user.id}" class="delete-user-checkbox">
                </td>
            </tr>
        </tbody>
        
    </table>
    <!-- Button to delete selected users -->
    <button class="delete-btn btn" type="button" th:onclick="'deleteSelectedUsers(' + ${projectId} + ',' + ${teamId} + ')'" th:if="${#authorization.expression('hasRole(''ROLE_ADMIN'')')}">Delete Selected</button>
   </div>
</div>


<!-- JavaScript function to handle adding employees to team -->
<script th:inline="javascript">
    function addEmployeesToTeam(projectId, teamId) {
        var form = document.getElementById('addEmployeeForm');
        var checkboxes = form.getElementsByClassName('employee-checkbox');
        var selectedUsers = [];
        
        // Iterate over checkboxes to find selected users
        for (var i = 0; i < checkboxes.length; i++) {
            if (checkboxes[i].checked) {
                selectedUsers.push(checkboxes[i].value);
            }
        }
        
        // If no users are selected, return
        if (selectedUsers.length === 0) {
            alert('Please select at least one employee.');
            return;
        }
        
        // Perform addition of selected employees to the team
        fetch('/project/' + projectId + '/teams/' + teamId + '/addUsers', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(selectedUsers)
        })
        .then(response => {
            if (response.ok) {
                location.reload(); // Reload the page after successful addition
            } else {
                alert('Failed to add employees to team.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to add employees to team.');
        });
    }

    // Function to toggle all checkboxes
    function toggleAllCheckboxes() {
        var checkboxes = document.getElementsByName('deleteUser');
        var selectAllCheckbox = document.getElementById('selectAllCheckbox');
        
        for (var i = 0; i < checkboxes.length; i++) {
            checkboxes[i].checked = selectAllCheckbox.checked;
        }
    }

    // Function to delete selected users
function deleteSelectedUsers(projectId, teamId) {
    var checkboxes = document.getElementsByName('deleteUser');
    var selectedUsers = [];
    
    // Iterate over checkboxes to find selected users
    for (var i = 0; i < checkboxes.length; i++) {
        if (checkboxes[i].checked) {
            selectedUsers.push(checkboxes[i].value);
        }
    }
    
    // If no users are selected, return
    if (selectedUsers.length === 0) {
        alert('Please select at least one user to delete.');
        return;
    }
    
    // Perform deletion of selected users from the team
    if (confirm('Are you sure you want to delete the selected users?')) {
        fetch('/project/assignment/delete/project/' + projectId + '/team/' + teamId + '/users', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(selectedUsers)
        })
        .then(response => {
            if (response.ok) {
                location.reload(); // Reload the page after successful deletion
            } else {
                alert('Failed to delete selected users.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to delete selected users.');
        });
    }
}
// Function to filter add employees
function filterAddEmployees() {
    var input, filter, table, tr, td, i, txtValue;
    input = document.getElementById("addEmployeeSearch");
    filter = input.value.toUpperCase();
    table = document.getElementById("addEmployeeTable");
    tr = table.getElementsByClassName("add-employee-row");
    for (i = 0; i < tr.length; i++) {
        td = tr[i].getElementsByTagName("td")[1]; // Index 1 for name column
        if (td) {
            txtValue = td.textContent || td.innerText;
            if (txtValue.toUpperCase().indexOf(filter) > -1) {
                tr[i].style.display = "";
            } else {
                tr[i].style.display = "none";
            }
        }
    }
}

// Function to filter delete employees
function filterDeleteEmployees() {
    var input, filter, table, tr, td, i, txtValue;
    input = document.getElementById("deleteEmployeeSearch");
    filter = input.value.toUpperCase();
    table = document.getElementById("deleteEmployeeTable");
    tr = table.getElementsByClassName("delete-employee-row");
    for (i = 0; i < tr.length; i++) {
        td = tr[i].getElementsByTagName("td")[0]; // Index 0 for name column
        if (td) {
            txtValue = td.textContent || td.innerText;
            if (txtValue.toUpperCase().indexOf(filter) > -1) {
                tr[i].style.display = "";
            } else {
                tr[i].style.display = "none";
            }
        }
    }
}

</script>
</body>
</html>